@page "/trainsetschedules"
@layout PrintLayout
@inject IStringLocalizer<App> Localizer
@inject NavigationManager Navigator
@inject Services.PrintedReportsService DataService

@if (Items == null)
{
    <CreatingReport />
}
else
{
    <RefreshButton OnClick="OnInitializedAsync" />

    @foreach (var itemsOnPage in Items.ItemsPerPage(10))
    {
        <div class="pagebreak">
            @foreach (var item in itemsOnPage)
            {
                <VehicleScheduleCard Item="@item"></VehicleScheduleCard>
            }
        </div>
    }
}

@code {
    string? SelectedOperatorNames { get; set; }
    private IEnumerable<TrainsetSchedule>? Items { get; set; }

    IEnumerable<TrainsetSchedule> Sorted (IEnumerable<TrainsetSchedule> items) =>
        items
            .Where(i => string.IsNullOrWhiteSpace(SelectedOperatorNames) || i.OperatorName.EqualsAny(SelectedOperatorNames))
            .OrderBy(i => i.OperatorName).ThenBy(i => i.TurnusNumber).ThenBy(i => i.OperationDaysFlags.FirstOperationDayFlag())
            .ToList();


    protected override async Task OnInitializedAsync()
    {
        var layoutResult = await DataService.GetLayoutAsync();
        if (layoutResult.statusCode.IsSuccess())
        {
            var result = await DataService.GetTrainsetSchedulesAsync(layoutResult.item!.Id);
            if (result.statusCode.IsSuccess())
            {
                SetQueryStringParameters();
                Items = Sorted(result.items);
            }            
        }
    }

    void SetQueryStringParameters()
    {
        var q = Navigator.QueryString();
        SelectedOperatorNames = q["operator"];
    }
}
